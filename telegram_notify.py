#!/usr/bin/env python3
"""
Telegramæ¨é€ - Elon Muskæ¨æ–‡æ•°æ®æ›´æ–°
"""

import json
import requests
from datetime import datetime

def load_config():
    """åŠ è½½Telegramé…ç½®"""
    try:
        with open('telegram_config.json', 'r') as f:
            return json.load(f)
    except:
        return None

def send_telegram_message(message):
    """å‘é€Telegramæ¶ˆæ¯"""

    config = load_config()

    if not config or not config.get('enabled'):
        print("âš ï¸  Telegramæœªé…ç½®æˆ–æœªå¯ç”¨")
        return False

    bot_token = config.get('bot_token')
    chat_id = config.get('chat_id')

    if bot_token == "YOUR_BOT_TOKEN_HERE" or chat_id == "YOUR_CHAT_ID_HERE":
        print("âš ï¸  è¯·å…ˆé…ç½®Telegram Bot Tokenå’ŒChat ID")
        return False

    try:
        url = f"https://api.telegram.org/bot{bot_token}/sendMessage"

        data = {
            'chat_id': chat_id,
            'text': message,
            'parse_mode': 'Markdown'
        }

        response = requests.post(url, json=data, timeout=10)

        if response.status_code == 200:
            print("âœ… Telegramæ¨é€æˆåŠŸ")
            return True
        else:
            print(f"âŒ Telegramæ¨é€å¤±è´¥: {response.text}")
            return False

    except Exception as e:
        print(f"âŒ Telegramæ¨é€é”™è¯¯: {e}")
        return False


def send_update_notification(today_count, recent_data, stats):
    """å‘é€æ›´æ–°é€šçŸ¥"""

    now = datetime.now()
    today_str = now.strftime("%Y-%m-%d")
    time_str = now.strftime("%H:%M")

    # è®¡ç®—è¶‹åŠ¿
    recent_3_avg = sum(r['count'] for r in recent_data[-3:]) / 3
    previous_3_avg = sum(r['count'] for r in recent_data[-6:-3]) / 3 if len(recent_data) >= 6 else recent_3_avg

    if recent_3_avg > previous_3_avg * 1.1:
        trend = "ğŸ“ˆ ä¸Šå‡"
    elif recent_3_avg < previous_3_avg * 0.9:
        trend = "ğŸ“‰ ä¸‹é™"
    else:
        trend = "â¡ï¸ ç¨³å®š"

    # æ„å»ºæ¶ˆæ¯
    message = f"""ğŸ¤– *Elon Musk æ¨æ–‡æ•°æ®æ›´æ–°*

ğŸ“… *{today_str}* | ğŸ• *{time_str}*

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š *ä»Šæ—¥æ•°æ®*
   ä»Šå¤©: *{today_count}* æ¡
   7å¤©å¹³å‡: {stats['7day_avg']:.1f} æ¡/å¤©

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ˆ *æœ€è¿‘3å¤©*
"""

    for day in recent_data[-3:]:
        message += f"   {day['date']}: {day['count']} æ¡\n"

    message += f"""
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‰ *è¶‹åŠ¿*: {trend}

ğŸ“Š *å†å²ç»Ÿè®¡*
   æ€»å¤©æ•°: {stats['total_days']} å¤©
   å¹³å‡: {stats['avg']:.1f} æ¡/å¤©
   æœ€é«˜: {stats['max']} æ¡

ğŸ“‚ Excelå·²æ›´æ–°
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ¤– Generated by polymarket-predictor
"""

    return message


def main():
    """ä¸»å‡½æ•° - å‘é€é€šçŸ¥"""

    # è¯»å–æœ€æ–°æ•°æ®
    with open('data/daily_tweets.json', 'r') as f:
        data = json.load(f)

    # è·å–ä»Šå¤©çš„æ•°é‡
    today_str = datetime.now().strftime("%Y-%m-%d")
    today_count = 0
    for record in data:
        if record['date'] == today_str:
            today_count = record['count']
            break

    # æœ€è¿‘æ•°æ®
    recent_data = sorted(data, key=lambda x: x['date'])[-7:]

    # ç»Ÿè®¡
    counts = [r['count'] for r in data]
    stats = {
        'total_days': len(data),
        'avg': sum(counts) / len(counts),
        'max': max(counts),
        '7day_avg': sum([r['count'] for r in recent_data]) / len(recent_data)
    }

    # å‘é€æ¶ˆæ¯
    message = send_update_notification(today_count, recent_data, stats)
    send_telegram_message(message)


if __name__ == "__main__":
    main()
